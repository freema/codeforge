# CodeForge — Production Docker Compose
#
# Usage:
#   export CODEFORGE_AUTH_TOKEN="your-secure-token"
#   export CODEFORGE_ENCRYPTION_KEY=$(openssl rand -base64 32)
#   docker compose -f docker-compose.production.yaml up -d
#
# Optional env vars:
#   CODEFORGE_WEBHOOKS__HMAC_SECRET  — HMAC secret for webhook callbacks
#   CODEFORGE_WORKERS__CONCURRENCY   — number of parallel workers (default: 3)
#   REDIS_PASSWORD                   — Redis password (recommended in production)

services:
  codeforge:
    image: ghcr.io/freema/codeforge:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      CODEFORGE_REDIS__URL: redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379
      CODEFORGE_SERVER__AUTH_TOKEN: ${CODEFORGE_AUTH_TOKEN:?Set CODEFORGE_AUTH_TOKEN}
      CODEFORGE_ENCRYPTION__KEY: ${CODEFORGE_ENCRYPTION_KEY:?Set CODEFORGE_ENCRYPTION_KEY}
      CODEFORGE_WEBHOOKS__HMAC_SECRET: ${CODEFORGE_WEBHOOKS__HMAC_SECRET:-}
      CODEFORGE_WORKERS__CONCURRENCY: ${CODEFORGE_WORKERS__CONCURRENCY:-3}
      CODEFORGE_LOGGING__LEVEL: info
      CODEFORGE_LOGGING__FORMAT: json
    volumes:
      - workspaces:/data/workspaces
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: >
      redis-server
      ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
      --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

volumes:
  workspaces:
  redis-data:
